#!/bin/sh
#
#  ________  ___       __   ___  ________
# |\   ____\|\  \     |\  \|\  \|\   ____\
# \ \  \___|\ \  \    \ \  \ \  \ \  \___|
#  \ \_____  \ \  \  __\ \  \ \  \ \  \  ___
#   \|____|\  \ \  \|\__\_\  \ \  \ \  \|\  \
#     ____\_\  \ \____________\ \__\ \_______\
#    |\_________\|____________|\|__|\|_______|
#    \|_________|

#    It's delicious.
#    Brought to you by the fine folks at Gilt (http://github.com/gilt)

bold=$(tput bold)
underline=$(tput sgr 0 1)
reset=$(tput sgr0)

red=$(tput setaf 1)
gray=$(tput setaf 8)
white=$(tput setaf 7)

dir=`dirname $0`
bin=`perl -e "print readlink '$0'"`
dir=`dirname $dir/$bin`
pkg=$(cat $dir/../package.json)

function version {
  prop='version'
  temp=`echo $pkg | sed 's/\\\\\//\//g' | sed 's/[{}]//g' | awk -v k="text" '{n=split($0,a,","); for (i=1; i<=n; i++) print a[i]}' | sed 's/\"\:\"/\|/g' | sed 's/[\,]/ /g' | sed 's/\"//g' | grep -w $prop | cut -d":" -f2 | sed -e 's/^ *//g' -e 's/ *$//g' `
  echo ${temp##*|}
}

echo "路\n路 ${bold}${white}hey guys! oh big gulps eh? - ${underline}${grey}http://youtu.be/praFGD51ih8${reset}\n路"
echo "路  ${bold}${red}Swig${reset}         v`version`"

# NVM is used here as a convenience and an assertion that we're using the right
# version of node. It's not required in production, as production should be using
# the right version of node (v11) natively.
if [ "$NODE_ENV" != "production" ]; then

  # source nvm for this session
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

  # run node 0.11.13. allow errors to pass through to the user.
  # we need 0.11.13 because 0.11.14 ships with npm 2.0.0, which breaks our auth.

  if [ ! -e "$NVM_DIR/v0.11.13" ]; then
    echo ".  ${gray}You don't have node v0.11.13 installed, doing that now:${reset}"
    nvm install 0.11.13
  fi

  nvm use v0.11.13 >/dev/null

fi

if [ "$1" == "init" ]; then
  node --harmony "$dir/../etc/init"
  exit
fi

if [ "$1" == "update" ]; then
  node --harmony "$dir/../etc/update"
  exit
fi

if [ "$1" == "dev" ]; then
  /bin/sh "$dir/../etc/dev"
  exit
fi

if [ ! -e "`which gulp`" ]; then
  echo ".  ${gray}You don't have gulp installed, doing that now:${reset}"
  sudo npm install -g gulp --registry=https://registry.npmjs.org/ --loglevel=http
  echo ".  ${gray}Global gulp installed.${reset}"
fi


# pass control to gulp
node --harmony `which gulp` "$@"
